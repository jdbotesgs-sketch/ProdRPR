<!doctype html>
<html lang="es">
<head>
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#ff7a00">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProdRPR - Webapp</title>
  <meta name="description" content="ProdRPR - Registro diario (guarda en localStorage y exporta TXT)">
  <style>
    :root{--orange:#ff7a00;--white:#ffffff;--gray:#f3f4f6;--muted:#6b7280;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    *{box-sizing:border-box}
    body{margin:0;background:var(--white);color:#111;font-family:inherit;line-height:1.3}
    .wrap{max-width:980px;margin:14px auto;padding:14px}
    .card{border:3px solid var(--orange);border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--white);border-bottom:4px solid var(--orange)}
    h1{margin:0;color:var(--orange);font-size:20px}
    small{color:var(--muted)}
    main{padding:16px;background:var(--gray)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;background:#fff}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .col-full{grid-column:1/-1}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;background:var(--orange);color:#fff;cursor:pointer}
    .btn.ghost{background:#fff;border:1px solid #ddd;color:#111}
    .panel{background:#fff;padding:12px;border-radius:10px}
    .list-item{border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa;display:flex;justify-content:space-between;align-items:flex-start}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .compact{padding:6px}
    .actions button{margin-left:6px}
    @media(max-width:700px){.grid{grid-template-columns:1fr}.row{flex-direction:column}}
  </style>
</head>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.error("Error registrando SW", err));
}
</script>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>ProdRPR</h1>
          <small>Registro diario RPR</small>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label class="small" style="margin:0">Fecha</label>
          <input id="date" type="date" />
        </div>
      </header>

      <main>
        <section class="panel" style="margin-bottom:12px">
          <label>NOMBRE DE LÍNEA</label>
          <input id="lineName" type="text" placeholder="Ej: Línea 1 - Almendralejo" />

          <label style="margin-top:10px">Tipo de Trabajo</label>
          <select id="workType">
            <option value="CENTROS">CENTROS</option>
            <option value="LINEA_AEREA">LINEA AÉREA</option>
          </select>
        </section>

        <!-- CENTROS -->
        <section class="panel" id="centrosPanel" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Registrar - CENTROS</h3>
          <div class="grid">
            <div>
              <label>Nombre del centro</label>
              <input id="c_name" type="text" />
            </div>
            <div>
              <label>Tipo</label>
              <select id="c_type"><option>CT</option><option>PT</option><option>ST</option></select>
            </div>
            <div>
              <label>Reposiciones</label>
              <input id="c_repos" type="number" min="0" value="0" />
            </div>
            <div>
              <label>Puntual</label>
              <div style="display:flex;align-items:center;gap:8px"><input id="c_punctual" type="checkbox" /><span class="muted">(no por defecto)</span></div>
            </div>
            <div class="col-full">
              <label>Defecto (descripción) — añadir para notificar</label>
              <div style="display:flex;gap:8px"><input id="c_defect_text" type="text" placeholder="Descripción del defecto" /><button id="c_add_defect" class="btn">Añadir</button></div>
              <div id="c_defects_list" style="margin-top:8px"></div>
            </div>
            <div class="col-full" style="display:flex;gap:8px;justify-content:flex-end">
              <button id="c_save" class="btn">Guardar centro</button>
              <button id="c_clear" class="btn ghost">Limpiar</button>
            </div>
          </div>
        </section>

        <!-- LINEA AÉREA -->
        <section class="panel" id="lineaPanel" style="margin-bottom:12px;display:none">
          <h3 style="margin:0 0 8px 0">Registrar - LÍNEA AÉREA</h3>
          <div class="grid">
            <div>
              <label>Reposiciones</label>
              <input id="l_repos" type="number" min="0" value="0" />
            </div>
            <div>
              <label>Medidas</label>
              <input id="l_medidas" type="number" min="0" value="0" />
            </div>
            <div>
              <label>Kilómetros revisados</label>
              <input id="l_kms" type="number" min="0" value="0" />
            </div>
            <div>
              <label>Flags</label>
              <div style="display:flex;gap:8px;align-items:center"><label><input id="l_med_punct" type="checkbox"/> Medidas puntual</label><label><input id="l_kms_punct" type="checkbox"/> Kms puntual</label></div>
            </div>

            <div class="col-full">
              <label>Defecto (ubicación + descripción)</label>
              <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px"><input id="l_def_ubic" placeholder="Ubicación" /><input id="l_def_desc" placeholder="Descripción" /><button id="l_add_def" class="btn">Añadir</button></div>
              <div id="l_defects_list" style="margin-top:8px"></div>
            </div>

            <div class="col-full" style="display:flex;gap:8px;justify-content:flex-end">
              <button id="l_save" class="btn">Guardar línea aérea</button>
              <button id="l_clear" class="btn ghost">Limpiar</button>
            </div>
          </div>
        </section>

        <!-- Incidencias -->
        <section class="panel" id="incPanel" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Incidencias</h3>
          <div class="grid">
            <div>
              <label>Incidencia</label>
              <input id="i_title" type="text" />
            </div>
            <div>
              <label>Ubicación</label>
              <input id="i_ubic" type="text" />
            </div>
            <div class="col-full">
              <label>Descripción</label>
              <textarea id="i_desc" rows="3"></textarea>
            </div>
            <div class="col-full" style="display:flex;gap:8px;justify-content:flex-end">
              <button id="i_save" class="btn">Guardar incidencia</button>
              <button id="i_clear" class="btn ghost">Limpiar</button>
            </div>
          </div>
        </section>

        <!-- Registro del día -->
        <section class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Registro del día</h3>
            <div style="display:flex;gap:8px">
              <button id="prepareLine" class="btn ghost">Preparar línea</button>
              <button id="exportBackup" class="btn ghost">Exportar backup JSON</button>
              <button id="clearAll" class="btn ghost">Borrar todo</button>
              <button id="exportTxt" class="btn">Exportar Prod_{fecha}.txt</button>
            </div>
          </div>

          <div id="records" style="margin-top:12px"></div>
        </section>

        <footer style="margin-top:10px;font-size:13px;color:var(--muted)">Consejo: para usar en Android sin instalar apk, abre este archivo en Chrome y usa "Añadir a pantalla de inicio".</footer>
      </main>
    </div>
  </div>

<script>
(function(){
  // Storage key
  const KEY = 'prodrpr_data_v1';

  // Elements
  const dateEl = document.getElementById('date');
  const lineEl = document.getElementById('lineName');
  const workTypeEl = document.getElementById('workType');

  // Centros
  const centrosPanel = document.getElementById('centrosPanel');
  const c_name = document.getElementById('c_name');
  const c_type = document.getElementById('c_type');
  const c_repos = document.getElementById('c_repos');
  const c_punctual = document.getElementById('c_punctual');
  const c_def_text = document.getElementById('c_defect_text');
  const c_add_def = document.getElementById('c_add_def');
  const c_def_list = document.getElementById('c_defects_list');
  const c_save = document.getElementById('c_save');
  const c_clear = document.getElementById('c_clear');

  // Linea aérea
  const lineaPanel = document.getElementById('lineaPanel');
  const l_repos = document.getElementById('l_repos');
  const l_medidas = document.getElementById('l_medidas');
  const l_kms = document.getElementById('l_kms');
  const l_med_punct = document.getElementById('l_med_punct');
  const l_kms_punct = document.getElementById('l_kms_punct');
  const l_def_ubic = document.getElementById('l_def_ubic');
  const l_def_desc = document.getElementById('l_def_desc');
  const l_add_def = document.getElementById('l_add_def');
  const l_def_list = document.getElementById('l_defects_list');
  const l_save = document.getElementById('l_save');
  const l_clear = document.getElementById('l_clear');

  // Incidencias
  const i_title = document.getElementById('i_title');
  const i_ubic = document.getElementById('i_ubic');
  const i_desc = document.getElementById('i_desc');
  const i_save = document.getElementById('i_save');
  const i_clear = document.getElementById('i_clear');

  // Actions
  const recordsEl = document.getElementById('records');
  const prepareLine = document.getElementById('prepareLine');
  const exportTxtBtn = document.getElementById('exportTxt');
  const exportBackup = document.getElementById('exportBackup');
  const clearAll = document.getElementById('clearAll');

  // State
  let db = loadDB();
  let c_defects = [];
  let l_defects = [];
  let editing = null; // {section,id}

  // Init date to today
  const today = new Date().toISOString().slice(0,10);
  dateEl.value = today;

  // UI toggles
  workTypeEl.addEventListener('change', ()=>{
    const v = workTypeEl.value;
    centrosPanel.style.display = v === 'CENTROS' ? '' : 'none';
    lineaPanel.style.display = v === 'LINEA_AEREA' ? '' : 'none';
  });

  // Centros defects
  c_add_def.addEventListener('click', ()=>{
    const t = c_def_text.value.trim(); if(!t) return;
    c_defects.push(t); c_def_text.value=''; renderCDefects();
  });
  function renderCDefects(){
    c_def_list.innerHTML='';
    c_defects.forEach((d,i)=>{
      const div = document.createElement('div'); div.className='list-item';
      div.innerHTML = `<div>${escapeHtml(d)}</div><div class="actions"><button data-i="${i}" class="btn ghost compact">Eliminar</button></div>`;
      c_def_list.appendChild(div);
    });
    c_def_list.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click',e=>{c_defects.splice(+e.target.dataset.i,1);renderCDefects();}))
  }

  // Linea defects
  l_add_def.addEventListener('click', ()=>{
    const u = l_def_ubic.value.trim(); const d = l_def_desc.value.trim(); if(!u && !d) return;
    l_defects.push({ubicacion:u,descripcion:d}); l_def_ubic.value=''; l_def_desc.value=''; renderLDefects();
  });
  function renderLDefects(){
    l_def_list.innerHTML='';
    l_defects.forEach((d,i)=>{
      const div = document.createElement('div'); div.className='list-item';
      div.innerHTML = `<div><strong>${escapeHtml(d.ubicacion)}</strong> — ${escapeHtml(d.descripcion)}</div><div class="actions"><button data-i="${i}" class="btn ghost compact">Eliminar</button></div>`;
      l_def_list.appendChild(div);
    });
    l_def_list.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click',e=>{l_defects.splice(+e.target.dataset.i,1);renderLDefects();}))
  }

  // Save centro
  c_save.addEventListener('click', ()=>{
    if(!lineEl.value.trim()){alert('Escribe primero el NOMBRE DE LÍNEA');return}
    const entry = {
      id: editing?.id || uid(),
      name: c_name.value.trim(),
      type: c_type.value,
      reposiciones: Number(c_repos.value)||0,
      defects: c_defects.slice().map(d=>({descripcion:d})),
      puntual: !!c_punctual.checked,
      createdAt: new Date().toISOString()
    };
    saveEntry(dateEl.value, lineEl.value.trim(), 'centros', entry);
    resetCentroForm(); renderAll();
  });
  c_clear.addEventListener('click', resetCentroForm);

  function resetCentroForm(){ c_name.value=''; c_type.value='CT'; c_repos.value=0; c_punctual.checked=false; c_defects=[]; renderCDefects(); editing=null; }

  // Save linea
  l_save.addEventListener('click', ()=>{
    if(!lineEl.value.trim()){alert('Escribe primero el NOMBRE DE LÍNEA');return}
    const entry = {
      id: editing?.id || uid(),
      reposiciones: Number(l_repos.value)||0,
      medidas: Number(l_medidas.value)||0,
      kms: Number(l_kms.value)||0,
      defects: l_defects.slice().map(d=>({ubicacion:d.ubicacion,descripcion:d.descripcion})),
      kmsPunctual: !!l_kms_punct.checked,
      medidasPunctual: !!l_med_punct.checked,
      createdAt: new Date().toISOString()
    };
    saveEntry(dateEl.value, lineEl.value.trim(), 'lineaAerea', entry);
    resetLineaForm(); renderAll();
  });
  l_clear.addEventListener('click', resetLineaForm);
  function resetLineaForm(){ l_repos.value=0; l_medidas.value=0; l_kms.value=0; l_kms_punct.checked=false; l_med_punct.checked=false; l_defects=[]; renderLDefects(); editing=null }

  // Save incidencia
  i_save.addEventListener('click', ()=>{
    if(!lineEl.value.trim()){alert('Escribe primero el NOMBRE DE LÍNEA');return}
    const entry = { id: editing?.id || uid(), incidencia: i_title.value.trim(), descripcion: i_desc.value.trim(), ubicacion: i_ubic.value.trim(), createdAt: new Date().toISOString() };
    saveEntry(dateEl.value, lineEl.value.trim(), 'incidencias', entry);
    i_title.value=''; i_desc.value=''; i_ubic.value=''; editing=null; renderAll();
  });
  i_clear.addEventListener('click', ()=>{ i_title.value=''; i_desc.value=''; i_ubic.value=''; editing=null });

  // Prepare line
  prepareLine.addEventListener('click', ()=>{
    if(!lineEl.value.trim()){alert('Escribe primero el NOMBRE DE LÍNEA');return}
    ensureDateLine(dateEl.value, lineEl.value.trim()); renderAll(); alert('Línea preparada para registrar trabajos');
  });

  // Export TXT
  exportTxtBtn.addEventListener('click', ()=>{
    exportTXT(dateEl.value);
  });

  // Export backup
  exportBackup.addEventListener('click', ()=>{
    const raw = JSON.stringify(db,null,2);
    downloadBlob(raw, `prodrpr_backup_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
  });

  // Clear all
  clearAll.addEventListener('click', ()=>{ if(confirm('¿Eliminar todos los datos guardados?')){db={}; saveDB(); renderAll(); alert('Datos eliminados')} });

  // Helpers: load/save
  function loadDB(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}') }catch(e){return {}} }
  function saveDB(){ localStorage.setItem(KEY, JSON.stringify(db)) }

  function ensureDateLine(d, line){ if(!db[d]) db[d]={}; if(!db[d][line]) db[d][line] = {centros:[],lineaAerea:[],incidencias:[]}; saveDB(); }

  function saveEntry(d, line, section, entry){ ensureDateLine(d,line); const list = db[d][line][section]; const idx = list.findIndex(it=>it.id===entry.id); if(idx>=0) list[idx]=entry; else list.push(entry); saveDB(); }

  function deleteEntry(d,line,section,id){ if(!confirm('Eliminar registro?')) return; if(db[d] && db[d][line]){ db[d][line][section]=db[d][line][section].filter(it=>it.id!==id); saveDB(); renderAll(); } }

  function editEntry(d,line,section,id){ const entry = db[d][line][section].find(it=>it.id===id); if(!entry) return; editing={section,id}; dateEl.value=d; lineEl.value=line; if(section==='centros'){ c_name.value=entry.name||''; c_type.value=entry.type||'CT'; c_repos.value=entry.reposiciones||0; c_punctual.checked=!!entry.puntual; c_defects = (entry.defects||[]).map(x=>x.descripcion||''); renderCDefects(); workTypeEl.value='CENTROS'; workTypeEl.dispatchEvent(new Event('change')); }
    if(section==='lineaAerea'){ l_repos.value=entry.reposiciones||0; l_medidas.value=entry.medidas||0; l_kms.value=entry.kms||0; l_kms_punct.checked=!!entry.kmsPunctual; l_med_punct.checked=!!entry.medidasPunctual; l_defects=(entry.defects||[]).map(x=>({ubicacion:x.ubicacion||'',descripcion:x.descripcion||''})); renderLDefects(); workTypeEl.value='LINEA_AEREA'; workTypeEl.dispatchEvent(new Event('change')); }
    if(section==='incidencias'){ i_title.value=entry.incidencia||''; i_desc.value=entry.descripcion||''; i_ubic.value=entry.ubicacion||''; workTypeEl.value='CENTROS'; workTypeEl.dispatchEvent(new Event('change')); }
  }

  // Render all records for selected date
  function renderAll(){ recordsEl.innerHTML=''; const d = dateEl.value; if(!db[d]){ recordsEl.innerHTML='<div class="muted">No hay registros para esta fecha.</div>'; return; }
    const lines = Object.keys(db[d]); if(lines.length===0){ recordsEl.innerHTML='<div class="muted">No hay registros para esta fecha.</div>'; return; }
    lines.forEach(line=>{
      const container = document.createElement('div'); container.className='panel'; container.style.marginBottom='8px';
      const h = document.createElement('div'); h.style.display='flex'; h.style.justifyContent='space-between'; h.style.alignItems='center';
      const title = document.createElement('h4'); title.textContent=line; title.style.margin='0';
      const controls = document.createElement('div'); controls.innerHTML = `<button class="btn ghost compact" data-line="${escapeHtml(line)}" data-action="export-line">Exportar Prod_${d}.txt</button><button class="btn ghost compact" data-line="${escapeHtml(line)}" data-action="delete-line">Borrar línea</button>`;
      h.appendChild(title); h.appendChild(controls); container.appendChild(h);

      // Centros
      const secC = document.createElement('div'); secC.style.marginTop='8px'; secC.innerHTML='<strong>Centros</strong>';
      const centros = db[d][line].centros||[]; if(centros.length===0){ const n=document.createElement('div'); n.className='muted'; n.textContent='(sin centros)'; secC.appendChild(n);} else{
        centros.forEach(c=>{ const li = document.createElement('div'); li.className='list-item'; li.innerHTML = `<div><div><strong>${escapeHtml(c.name)}</strong> — ${escapeHtml(c.type)}</div><div class="small muted">Reposiciones: ${c.reposiciones} · Puntual: ${c.puntual? 'SI':'NO'}</div>${(c.defects||[]).length? '<ul class="small" style="margin-top:6px">'+(c.defects||[]).map(df=>`<li>${escapeHtml(df.descripcion)}</li>`).join('')+'</ul>':''}</div><div class="actions"><button class="btn ghost compact" data-id="${c.id}" data-section="centros" data-line="${escapeHtml(line)}">Editar</button><button class="btn ghost compact" data-del="${c.id}" data-section="centros" data-line="${escapeHtml(line)}">Eliminar</button></div>`; secC.appendChild(li) }); }
      container.appendChild(secC);

      // Linea aérea
      const secL = document.createElement('div'); secL.style.marginTop='8px'; secL.innerHTML='<strong>Línea Aérea</strong>';
      const la = db[d][line].lineaAerea||[]; if(la.length===0){ const n=document.createElement('div'); n.className='muted'; n.textContent='(sin registros de línea aérea)'; secL.appendChild(n);} else{
        la.forEach(item=>{ const li = document.createElement('div'); li.className='list-item'; li.innerHTML = `<div><div class="small">Reposiciones: ${item.reposiciones} · Medidas: ${item.medidas} (P: ${item.medidasPunctual? 'SI':'NO'}) · Kms: ${item.kms} (P: ${item.kmsPunctual? 'SI':'NO'})</div>${(item.defects||[]).length? '<ul class="small" style="margin-top:6px">'+(item.defects||[]).map(df=>`<li>${escapeHtml(df.ubicacion)} — ${escapeHtml(df.descripcion)}</li>`).join('')+'</ul>':''}</div><div class="actions"><button class="btn ghost compact" data-id="${item.id}" data-section="lineaAerea" data-line="${escapeHtml(line)}">Editar</button><button class="btn ghost compact" data-del="${item.id}" data-section="lineaAerea" data-line="${escapeHtml(line)}">Eliminar</button></div>`; secL.appendChild(li) }); }
      container.appendChild(secL);

      // Incidencias
      const secI = document.createElement('div'); secI.style.marginTop='8px'; secI.innerHTML='<strong>Incidencias</strong>';
      const incs = db[d][line].incidencias||[]; if(incs.length===0){ const n=document.createElement('div'); n.className='muted'; n.textContent='(sin incidencias)'; secI.appendChild(n);} else{
        incs.forEach(it=>{ const li = document.createElement('div'); li.className='list-item'; li.innerHTML = `<div><div><strong>${escapeHtml(it.incidencia)}</strong> · Ubicación: ${escapeHtml(it.ubicacion)}</div><div class="small">${escapeHtml(it.descripcion)}</div></div><div class="actions"><button class="btn ghost compact" data-id="${it.id}" data-section="incidencias" data-line="${escapeHtml(line)}">Editar</button><button class="btn ghost compact" data-del="${it.id}" data-section="incidencias" data-line="${escapeHtml(line)}">Eliminar</button></div>`; secI.appendChild(li) }); }
      container.appendChild(secI);

      recordsEl.appendChild(container);
    });

    // attach event handlers for edit/delete/export-line/delete-line
    recordsEl.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click', e=>{ const id=e.target.dataset.id; const section=e.target.dataset.section; const line=e.target.dataset.line; editEntry(dateEl.value,line,section,id); }))
    recordsEl.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', e=>{ const id=e.target.dataset.del; const section=e.target.dataset.section; const line=e.target.dataset.line; deleteEntry(dateEl.value,line,section,id); }))
    recordsEl.querySelectorAll('button[data-action]').forEach(b=>b.addEventListener('click', e=>{ const action=e.target.dataset.action; const line= e.target.dataset.line; if(action==='export-line'){ exportTXTforLine(dateEl.value, line); } if(action==='delete-line'){ if(confirm('Eliminar TODOS los registros de esta línea en esta fecha?')){ delete db[dateEl.value][line]; saveDB(); renderAll(); } } }))
  }

  // Export TXT whole day
  function exportTXT(d){ if(!db[d]){ alert('No hay registros para esa fecha'); return; } const lines = Object.keys(db[d]); const parts=[]; lines.forEach(ln=>{ parts.push(`LINEA: ${ln}`); const obj = db[d][ln]; parts.push('  CENTROS:'); if((obj.centros||[]).length===0) parts.push('    (sin centros)'); obj.centros.forEach(c=>{ parts.push(`    - Centro: ${c.name} [Tipo: ${c.type}]`); parts.push(`      Reposiciones: ${c.reposiciones}`); parts.push(`      Puntual: ${c.puntual ? 'SI' : 'NO'}`); if((c.defects||[]).length>0){ parts.push('      Defectos:'); c.defects.forEach(df=>parts.push(`        * ${df.descripcion}`)); } }); parts.push('  LÍNEA AÉREA:'); if((obj.lineaAerea||[]).length===0) parts.push('    (sin registros de línea aérea)'); obj.lineaAerea.forEach(la=>{ parts.push(`    - Reposiciones: ${la.reposiciones}`); parts.push(`      Medidas: ${la.medidas}  (Puntual: ${la.medidasPunctual ? 'SI' : 'NO'})`); parts.push(`      Kms revisados: ${la.kms}  (Puntual: ${la.kmsPunctual ? 'SI' : 'NO'})`); if((la.defects||[]).length>0){ parts.push('      Defectos:'); la.defects.forEach(df=>parts.push(`        * Ubic: ${df.ubicacion} - ${df.descripcion}`)); } }); parts.push('  INCIDENCIAS:'); if((obj.incidencias||[]).length===0) parts.push('    (sin incidencias)'); obj.incidencias.forEach(inc=>{ parts.push(`    - ${inc.incidencia || '(sin título)'} | Ubicación: ${inc.ubicacion || '(sin ubicación)'}`); parts.push(`      ${inc.descripcion || ''}`); }); parts.push(''); }); const content = parts.join('\n'); downloadBlob(content, `Prod_${d}.txt`, 'text/plain'); }

  function exportTXTforLine(d, line){ if(!db[d]||!db[d][line]){ alert('No hay registros para esa línea en esa fecha'); return; } const obj=db[d][line]; const parts=[]; parts.push(`LINEA: ${line}`); parts.push('  CENTROS:'); if((obj.centros||[]).length===0) parts.push('    (sin centros)'); obj.centros.forEach(c=>{ parts.push(`    - Centro: ${c.name} [Tipo: ${c.type}]`); parts.push(`      Reposiciones: ${c.reposiciones}`); parts.push(`      Puntual: ${c.puntual ? 'SI' : 'NO'}`); if((c.defects||[]).length>0){ parts.push('      Defectos:'); c.defects.forEach(df=>parts.push(`        * ${df.descripcion}`)); } }); parts.push('  LÍNEA AÉREA:'); if((obj.lineaAerea||[]).length===0) parts.push('    (sin registros de línea aérea)'); obj.lineaAerea.forEach(la=>{ parts.push(`    - Reposiciones: ${la.reposiciones}`); parts.push(`      Medidas: ${la.medidas}  (Puntual: ${la.medidasPunctual ? 'SI' : 'NO'})`); parts.push(`      Kms revisados: ${la.kms}  (Puntual: ${la.kmsPunctual ? 'SI' : 'NO'})`); if((la.defects||[]).length>0){ parts.push('      Defectos:'); la.defects.forEach(df=>parts.push(`        * Ubic: ${df.ubicacion} - ${df.descripcion}`)); } }); parts.push('  INCIDENCIAS:'); if((obj.incidencias||[]).length===0) parts.push('    (sin incidencias)'); obj.incidencias.forEach(inc=>{ parts.push(`    - ${inc.incidencia || '(sin título)'} | Ubicación: ${inc.ubicacion || '(sin ubicación)'}`); parts.push(`      ${inc.descripcion || ''}`); }); const content = parts.join('\n'); downloadBlob(content, `Prod_${d}_${sanitizeFilename(line)}.txt`, 'text/plain'); }

  // Utilities
  function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7) }
  function downloadBlob(content, filename, mime){ const blob = new Blob([content], {type: mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
  function deleteEntry(d,line,section,id){ if(!confirm('Eliminar registro?')) return; if(db[d] && db[d][line]){ db[d][line][section]=db[d][line][section].filter(it=>it.id!==id); saveDB(); renderAll(); } }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,function(m){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]}) }
  function sanitizeFilename(s){ return s.replace(/[^a-z0-9\.\-_]/gi,'_') }

  // Init: render existing
  renderAll();

  // Listen to date change
  dateEl.addEventListener('change', renderAll);

})();
</script>
</body>
</html>
